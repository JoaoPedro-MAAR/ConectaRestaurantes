<div class="form-wrapper">
  <form [formGroup]="menuForm">
    
    <div class="header-form">
        <h1>{{ isEditMode ? 'Edição' : 'Criação' }} de Cardápio</h1>
        <div *ngIf="isEditMode" class="badge-id">ID: {{ menuId }}</div>
    </div>

    <div class="card-section">
        <h3>Dados Gerais</h3>
        
        <div class="form-group">
            <label for="nome">Nome do Cardápio: <span class="text-danger">*</span></label>
            <input 
                id="nome" 
                formControlName="nome" 
                type="text" 
                placeholder="Ex: Almoço de Domingo"
                [class.invalid-border]="menuForm.get('nome')?.invalid && menuForm.get('nome')?.touched"
            >
            <small class="error-message" *ngIf="menuForm.get('nome')?.invalid && menuForm.get('nome')?.touched">
                Nome obrigatório.
            </small>
        </div>

        <div class="form-group">
            <label for="description">Descrição:</label>
            <input id="description" formControlName="description" type="text" placeholder="Ex: Disponível das 11h às 14h">
        </div>

        <div class="form-group">
        <label for="diaSemana">Dia da Semana:</label>
        <select id="diaSemana" formControlName="diaSemana">
            <option value="">Selecione um dia (opcional)</option>
            <option *ngFor="let dia of diasSemana" [value]="dia">{{ dia }}</option>
        </select>
        </div>
    </div>

    <hr class="divider">

    <div class="categories-area">
        
        <div class="flex-between">
            <h3>Categorias do Cardápio</h3>
            <div class="d-flex gap-2" style="display: flex; gap: 10px;">
                <button type="button" class="btn-secondary" style="background-color: #6c757d;" (click)="addPratosFeitosCategory()">
                    + Adicionar Pratos Feitos
                </button>
                <button type="button" class="btn-secondary" (click)="addCategory()">
                    + Adicionar Categoria
                </button>
            </div>
        </div>

        <div formArrayName="categorias">
            <div *ngFor="let cat of categorias.controls; let i = index" [formGroupName]="i" class="category-card">
                
                <div class="category-header">
                    <span class="cat-number">#{{ i + 1 }}</span>
                    <button type="button" class="btn-icon-remove" (click)="removeCategory(i)" title="Remover Categoria">
                        &times;
                    </button>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label>Título da Categoria <span class="text-danger">*</span></label>
                        <input 
                            type="text" 
                            formControlName="nome" 
                            placeholder="Ex: Prato Principal, Bebidas..."
                            [readonly]="cat.get('isPratoFeitoSection')?.value === true"
                            [class.bg-light]="cat.get('isPratoFeitoSection')?.value === true"
                            [style.background-color]="cat.get('isPratoFeitoSection')?.value === true ? '#e9ecef' : ''"
                        >
                    </div>
                    <div class="form-group col-md-4">
                        <label>Limite de Escolhas</label>
                        <input type="number" formControlName="limiteMaximoEscolhas" min="1">
                    </div>
                </div>

                <div class="form-group position-relative">
                    <label>Itens desta Categoria:</label>
                    
                    <input 
                        #inputSearch
                        type="text" 
                        placeholder="Buscar item para adicionar..." 
                        (input)="onSearch($event, i)"
                        (blur)="onBlur()"
                        autocomplete="off"
                    >

                    <div class="tag-container">
                        <div *ngFor="let item of cat.get('itens')?.value; let itemIndex = index" class="tag">
                            <span>{{ item.nome }}</span>
                            <span class="remove-btn" (click)="removeItemFromCategory(i, itemIndex)">&times;</span>
                        </div>
                        <div *ngIf="cat.get('itens')?.value?.length === 0" class="empty-tags">
                            Nenhum item adicionado nesta categoria ainda.
                        </div>
                    </div>

                    <ul *ngIf="activeSearchCategoryIndex === i && filteredItems.length > 0" class="dropdown-list">
                        <li 
                            *ngFor="let option of filteredItems" 
                            (mousedown)="selectItem(option, i, inputSearch)"
                        >
                            {{ option.nome }} <small>({{ option.categoria }})</small>
                        </li>
                    </ul>
                </div>

            </div>
        </div>
        
        <div *ngIf="categorias.controls.length === 0" class="empty-state-cat">
            Nenhuma categoria criada. Clique em "+ Adicionar Categoria".
        </div>

    </div>

    <div class="button-group sticky-footer">
      <button type="button" class="btn-back" (click)="goBack()">Voltar</button>
      <button type="button" class="btn-clear" (click)="clearForm()">Limpar</button>
      <button type="submit" class="btn-save" (click)="saveMenu()">Salvar Cardápio</button> 
    </div>

  </form>
</div>